AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: >
  tndx-us-east-2-test-stack

  The Twitter ndx

Parameters:
  ParamAppName:
    Type: String
    Default: tndx
    Description: Application/stack name.

  ParamDDBParamTable:
    Type: String
    Default: tndx-parameters
    Description: DDD table to store parameters.

  ParamDDBRunnerTable:
    Type: String
    Default: tndx-runner
    Description: DDD runner table.

  ParamDeliveryStreamTimelinesName:
    Type: String
    Default: tndx-timelines
    Description: Delivery stream for timelines.

  ParamEnvironment:
    Type: String
    Default: staging
    AllowedValues:
      - dev
      - staging
      - prod
    Description: Environment for deployment.

  ParamGlueDatabaseName:
    Type: String
    Default: tndx_us_east_2
    Description: Glue database name.

  ParamGlueTableNameTndxTimelines:
    Type: String
    Default: timelines
    Description: Glue table name for tndx timelines.

  ParamRegion:
    Type: String
    Default: us-east-2
    AllowedValues:
      - us-east-1
      - us-east-2
      - us-west-1
      - us-west-2
    Description: The AWS Region for deployment.

  S3BucketName:
    Type: String
    Default: is-tndx-us-east-2
    Description: Priamry S3 bucket.

  SQSName:
    Type: String
    Default: tndx-runner
    Description: Priamry S3 bucket.

  TwitterAPIKey:
    Type: String
    Default: your-twitter-api-key
    Description: Twitter API key.

  TwitterAPISecret:
    Type: String
    Default: your-twitter-api-secret
    Description: Twitter API secret.

Globals:
  Function:
    Timeout: 60

Resources:
  DDBParametersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Ref ParamDDBParamTable
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: UserID
          AttributeType: N
        - AttributeName: Domain
          AttributeType: S
      KeySchema:
        - AttributeName: UserID
          KeyType: HASH
        - AttributeName: Domain
          KeyType: RANGE
      Tags:
        - Key: "Environment"
          Value: { Ref: ParamEnvironment }
        - Key: "Application"
          Value: { Ref: ParamAppName }

  DDBRunnerTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Ref ParamDDBRunnerTable
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: RunnerName
          AttributeType: S
        - AttributeName: UserID
          AttributeType: N
      KeySchema:
        - AttributeName: RunnerName
          KeyType: HASH
        - AttributeName: UserID
          KeyType: RANGE
      Tags:
        - Key: "Environment"
          Value: { Ref: ParamEnvironment }
        - Key: "Application"
          Value: { Ref: ParamAppName }

  DeliveryStreamTimelines:
    Type: AWS::KinesisFirehose::DeliveryStream
    Properties:
      DeliveryStreamType: DirectPut
      DeliveryStreamName: !Ref ParamDeliveryStreamTimelinesName
      Tags:
        - Key: "Environment"
          Value: { Ref: ParamEnvironment }
        - Key: "Application"
          Value: { Ref: ParamAppName }
      ExtendedS3DestinationConfiguration:
        RoleARN: !GetAtt RoleDelivery.Arn
        BucketARN: !Join
          - ""
          - - "arn:aws:s3:::"
            - !Ref S3Bucket
        Prefix: "processed/timelines/user_id=!{partitionKeyFromQuery:user_id}/screen_name=!{partitionKeyFromQuery:screen_name}/"
        ErrorOutputPrefix: "errors/timelines/"
        BufferingHints:
          SizeInMBs: 128
          IntervalInSeconds: 300
        CompressionFormat: UNCOMPRESSED
        EncryptionConfiguration:
          NoEncryptionConfig: NoEncryption
        CloudWatchLoggingOptions:
          Enabled: true
          LogGroupName: !Join
            - ""
            - - "KDF-"
              - !Ref GlueTableTndxTimelines
          LogStreamName: S3Delivery
        S3BackupMode: Enabled
        S3BackupConfiguration:
          RoleARN: !GetAtt RoleDelivery.Arn
          BucketARN: !Join
            - ""
            - - "arn:aws:s3:::"
              - !Ref S3Bucket
          Prefix: "backup/timelines/"
          ErrorOutputPrefix: "backup/timelines/errors/"
          BufferingHints:
            SizeInMBs: 128
            IntervalInSeconds: 300
          CompressionFormat: GZIP
          EncryptionConfiguration:
            NoEncryptionConfig: NoEncryption
          CloudWatchLoggingOptions:
            Enabled: true
            LogGroupName: !Join
              - ""
              - - "KDF-Backup"
                - !Ref GlueTableTndxTimelines
            LogStreamName: S3Delivery
        DynamicPartitioningConfiguration:
          Enabled: true
          RetryOptions:
            DurationInSeconds: 300
        ProcessingConfiguration:
          Enabled: true
          Processors:
            - Type: MetadataExtraction
              Parameters:
                - ParameterName: MetadataExtractionQuery
                  ParameterValue: "{user_id : (.user.id), screen_name : (.user.screen_name)}"
                - ParameterName: JsonParsingEngine
                  ParameterValue: JQ-1.6
        DataFormatConversionConfiguration:
          SchemaConfiguration:
            CatalogId: !Ref AWS::AccountId
            RoleARN: !GetAtt RoleDelivery.Arn
            DatabaseName: !Ref GlueDatabaseTndx
            TableName: !Ref GlueTableTndxTimelines
            Region: !Ref AWS::Region
            VersionId: LATEST
          InputFormatConfiguration:
            Deserializer:
              OpenXJsonSerDe: {}
          OutputFormatConfiguration:
            Serializer:
              ParquetSerDe: {}
          Enabled: True

  EventTndxRunnerFavorites:
    Type: AWS::Events::Rule
    Properties:
      Description: Run a tndx runner for favorites
      ScheduleExpression: "rate(15 minutes)"
      State: DISABLED
      Targets:
        - Arn: !GetAtt FunctionTndxRunner.Arn
          Id: TargetFunctionTndxRunnerFavorites
          Input: !Sub |
            {
              "runner_name": "tndx-rmrfslashbin-01",
              "function": "favorites",
              "region": "${ParamRegion}",
              "ddb_params_table": "${ParameterDDBParams}",
              "ddb_runner_table": "${ParameterDDBRunner}",
              "sqs_runner_url": "${ParameterSQSRunner}",
              "s3_bucket": "${ParameterS3Bucket}",
              "twitter_api_key": "${ParameterTwitterAPIKey}",
              "twitter_api_secret": "${ParameterTwitterAPISecret}"
            }

  EventTndxRunnerFollowers:
    Type: AWS::Events::Rule
    Properties:
      Description: Run a tndx runner for followers
      ScheduleExpression: "rate(60 minutes)"
      State: DISABLED
      Targets:
        - Arn: !GetAtt FunctionTndxRunner.Arn
          Id: TargetFunctionTndxRunnerFollowers
          Input: !Sub |
            {
              "runner_name": "tndx-rmrfslashbin-01",
              "function": "followers",
              "region": "${ParamRegion}",
              "ddb_params_table": "${ParameterDDBParams}",
              "ddb_runner_table": "${ParameterDDBRunner}",
              "sqs_runner_url": "${ParameterSQSRunner}",
              "s3_bucket": "${ParameterS3Bucket}",
              "twitter_api_key": "${ParameterTwitterAPIKey}",
              "twitter_api_secret": "${ParameterTwitterAPISecret}"
            }

  EventTndxRunnerFriends:
    Type: AWS::Events::Rule
    Properties:
      Description: Run a tndx runner for friends
      ScheduleExpression: "rate(60 minutes)"
      State: DISABLED
      Targets:
        - Arn: !GetAtt FunctionTndxRunner.Arn
          Id: TargetFunctionTndxRunnerFriends
          Input: !Sub |
            {
              "runner_name": "tndx-rmrfslashbin-01",
              "function": "friends",
              "region": "${ParamRegion}",
              "ddb_params_table": "${ParameterDDBParams}",
              "ddb_runner_table": "${ParameterDDBRunner}",
              "sqs_runner_url": "${ParameterSQSRunner}",
              "s3_bucket": "${ParameterS3Bucket}",
              "twitter_api_key": "${ParameterTwitterAPIKey}",
              "twitter_api_secret": "${ParameterTwitterAPISecret}"
            }

  EventTndxRunnerTimeline:
    Type: AWS::Events::Rule
    Properties:
      Description: Run a tndx runner for timelines
      ScheduleExpression: "rate(5 minutes)"
      State: DISABLED
      Targets:
        - Arn: !GetAtt FunctionTndxRunner.Arn
          Id: TargetFunctionTndxRunnerTimeline
          Input: !Sub |
            {
              "runner_name": "tndx-rmrfslashbin-01",
              "function": "timeline",
              "region": "${ParamRegion}",
              "ddb_params_table": "${ParameterDDBParams}",
              "ddb_runner_table": "${ParameterDDBRunner}",
              "sqs_runner_url": "${ParameterSQSRunner}",
              "s3_bucket": "${ParameterS3Bucket}",
              "twitter_api_key": "${ParameterTwitterAPIKey}",
              "twitter_api_secret": "${ParameterTwitterAPISecret}"
            }

  EventTndxRunnerUser:
    Type: AWS::Events::Rule
    Properties:
      Description: Run a tndx runner for user
      ScheduleExpression: "rate(12 hours)"
      State: DISABLED
      Targets:
        - Arn: !GetAtt FunctionTndxRunner.Arn
          Id: TargetFunctionTndxRunnerUser
          Input: !Sub |
            {
              "runner_name": "tndx-rmrfslashbin-01",
              "function": "user",
              "region": "${ParamRegion}",
              "ddb_params_table": "${ParameterDDBParams}",
              "ddb_runner_table": "${ParameterDDBRunner}",
              "sqs_runner_url": "${ParameterSQSRunner}",
              "s3_bucket": "${ParameterS3Bucket}",
              "twitter_api_key": "${ParameterTwitterAPIKey}",
              "twitter_api_secret": "${ParameterTwitterAPISecret}"
            }

  FunctionTndxProcessor:
    Type: AWS::Serverless::Function
    Properties:
      Description: Tndx Processor
      FunctionName: !Sub ${ParamAppName}-processor-${ParamEnvironment}
      CodeUri: ../bin/tndx-processor
      Handler: bootstrap
      Runtime: provided.al2
      Architectures: [arm64]
      Role: !GetAtt RoleLambdaExecution.Arn
      Tags:
        Environment: { Ref: ParamEnvironment }
        Application: { Ref: ParamAppName }
      Events:
        EventSQSTndxRunnerToFunctionTndxProcessor:
          Type: SQS
          Properties:
            Queue: !GetAtt SQSTndxRunner.Arn
            Enabled: true

  FunctionTndxRunner:
    Type: AWS::Serverless::Function
    Properties:
      Description: Runner function
      FunctionName: !Sub ${ParamAppName}-runner-${ParamEnvironment}
      CodeUri: ../bin/tndx-runner
      Handler: bootstrap
      Runtime: provided.al2
      Architectures: [arm64]
      Role: !GetAtt RoleLambdaExecution.Arn
      Tags:
        Environment: { Ref: ParamEnvironment }
        Application: { Ref: ParamAppName }

  GlueDatabaseTndx:
    Type: AWS::Glue::Database
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseInput:
        Name: !Ref ParamGlueDatabaseName
        Description: tndx database

  GlueTableTndxTimelines:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref GlueDatabaseTndx
      TableInput:
        Description: tndx timelines table
        Name: !Ref ParamGlueTableNameTndxTimelines
        StorageDescriptor:
          Columns:
            - Name: coordinates
              Type: struct<coordinates:array<double>,type:string>
            - Name: created_at
              Type: string
            - Name: current_user_retweet
              Type: string
            - Name: entities
              Type: struct<hashtags:array<struct<indices:array<int>,text:string>>,media:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string,id:bigint,id_str:string,media_url:string,media_url_https:string,source_status_id:bigint,source_status_id_str:string,type:string,sizes:struct<thumb:struct<w:int,h:int,resize:string>,large:struct<w:int,h:int,resize:string>,medium:struct<w:int,h:int,resize:string>,small:struct<w:int,h:int,resize:string>>,video_info:struct<aspect_ratio:array<int>,duration_millis:int,variants:string>>>,urls:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string>>,user_mentions:array<struct<indices:array<int>,id:bigint,id_str:string,name:string,screen_name:string>>>
            - Name: favorite_count
              Type: int
            - Name: favorited
              Type: boolean
            - Name: filter_level
              Type: string
            - Name: id
              Type: bigint
            - Name: id_str
              Type: string
            - Name: in_reply_to_screen_name
              Type: string
            - Name: in_reply_to_status_id
              Type: bigint
            - Name: in_reply_to_status_id_str
              Type: string
            - Name: in_reply_to_user_id
              Type: bigint
            - Name: in_reply_to_user_id_str
              Type: string
            - Name: lang
              Type: string
            - Name: possibly_sensitive
              Type: boolean
            - Name: quote_count
              Type: bigint
            - Name: reply_count
              Type: int
            - Name: retweet_count
              Type: int
            - Name: retweeted
              Type: boolean
            - Name: retweeted_status
              Type: struct<coordinates:string,created_at:string,current_user_retweet:string,entities:struct<hashtags:array<struct<indices:array<int>,text:string>>,media:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string,id:bigint,id_str:string,media_url:string,media_url_https:string,source_status_id:bigint,source_status_id_str:string,type:string,sizes:struct<thumb:struct<w:int,h:int,resize:string>,large:struct<w:int,h:int,resize:string>,medium:struct<w:int,h:int,resize:string>,small:struct<w:int,h:int,resize:string>>,video_info:struct<aspect_ratio:array<int>,duration_millis:int,variants:string>>>,urls:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string>>,user_mentions:array<struct<indices:array<int>,id:bigint,id_str:string,name:string,screen_name:string>>>,favorite_count:int,favorited:boolean,filter_level:string,id:bigint,id_str:string,in_reply_to_screen_name:string,in_reply_to_status_id:bigint,in_reply_to_status_id_str:string,in_reply_to_user_id:bigint,in_reply_to_user_id_str:string,lang:string,possibly_sensitive:boolean,quote_count:int,reply_count:int,retweet_count:int,retweeted:boolean,retweeted_status:string,source:string,scopes:string,text:string,full_text:string,display_text_range:array<int>,place:struct<attributes:string,bounding_box:struct<coordinates:array<array<array<double>>>,type:string>,country:string,country_code:string,full_name:string,geometry:string,id:string,name:string,place_type:string,polylines:string,url:string>,truncated:boolean,user:struct<contributors_enabled:boolean,created_at:string,default_profile:boolean,default_profile_image:boolean,description:string,email:string,entities:struct<url:struct<hashtags:string,media:string,urls:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string>>,user_mentions:string>,description:struct<hashtags:string,media:string,urls:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string>>,user_mentions:string>>,favourites_count:int,follow_request_sent:boolean,followers_count:int,friends_count:int,geo_enabled:boolean,id:bigint,id_str:string,is_translator:boolean,lang:string,listed_count:int,location:string,name:string,notifications:boolean,profile_background_color:string,profile_background_image_url:string,profile_background_image_url_https:string,profile_background_tile:boolean,profile_banner_url:string,profile_image_url:string,profile_image_url_https:string,profile_link_color:string,profile_sidebar_border_color:string,profile_sidebar_fill_color:string,profile_text_color:string,profile_use_background_image:boolean,protected:boolean,screen_name:string,show_all_inline_media:boolean,status:string,statuses_count:int,time_zone:string,url:string,utc_offset:int,verified:boolean,withheld_in_countries:array<string>,withheld_scope:string>,withheld_copyright:boolean,withheld_in_countries:string,withheld_scope:string,extended_entities:struct<media:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string,id:bigint,id_str:string,media_url:string,media_url_https:string,source_status_id:bigint,source_status_id_str:string,type:string,sizes:struct<thumb:struct<w:int,h:int,resize:string>,large:struct<w:int,h:int,resize:string>,medium:struct<w:int,h:int,resize:string>,small:struct<w:int,h:int,resize:string>>,video_info:struct<aspect_ratio:array<int>,duration_millis:int,variants:array<struct<content_type:string,bitrate:int,url:string>>>>>>,extended_tweet:string,quoted_status_id:bigint,quoted_status_id_str:string,quoted_status:struct<coordinates:string,created_at:string,current_user_retweet:string,entities:struct<hashtags:array<struct<indices:array<int>,text:string>>,media:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string,id:bigint,id_str:string,media_url:string,media_url_https:string,source_status_id:bigint,source_status_id_str:string,type:string,sizes:struct<thumb:struct<w:int,h:int,resize:string>,large:struct<w:int,h:int,resize:string>,medium:struct<w:int,h:int,resize:string>,small:struct<w:int,h:int,resize:string>>,video_info:struct<aspect_ratio:array<int>,duration_millis:int,variants:string>>>,urls:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string>>,user_mentions:array<struct<indices:array<int>,id:bigint,id_str:string,name:string,screen_name:string>>>,favorite_count:int,favorited:boolean,filter_level:string,id:bigint,id_str:string,in_reply_to_screen_name:string,in_reply_to_status_id:bigint,in_reply_to_status_id_str:string,in_reply_to_user_id:bigint,in_reply_to_user_id_str:string,lang:string,possibly_sensitive:boolean,quote_count:int,reply_count:int,retweet_count:int,retweeted:boolean,retweeted_status:string,source:string,scopes:string,text:string,full_text:string,display_text_range:array<int>,place:struct<attributes:string,bounding_box:struct<coordinates:array<array<array<double>>>,type:string>,country:string,country_code:string,full_name:string,geometry:string,id:string,name:string,place_type:string,polylines:string,url:string>,truncated:boolean,user:struct<contributors_enabled:boolean,created_at:string,default_profile:boolean,default_profile_image:boolean,description:string,email:string,entities:struct<url:struct<hashtags:string,media:string,urls:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string>>,user_mentions:string>,description:struct<hashtags:string,media:string,urls:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string>>,user_mentions:string>>,favourites_count:int,follow_request_sent:boolean,followers_count:int,friends_count:int,geo_enabled:boolean,id:bigint,id_str:string,is_translator:boolean,lang:string,listed_count:int,location:string,name:string,notifications:boolean,profile_background_color:string,profile_background_image_url:string,profile_background_image_url_https:string,profile_background_tile:boolean,profile_banner_url:string,profile_image_url:string,profile_image_url_https:string,profile_link_color:string,profile_sidebar_border_color:string,profile_sidebar_fill_color:string,profile_text_color:string,profile_use_background_image:boolean,protected:boolean,screen_name:string,show_all_inline_media:boolean,status:string,statuses_count:int,time_zone:string,url:string,utc_offset:int,verified:boolean,withheld_in_countries:array<string>,withheld_scope:string>,withheld_copyright:boolean,withheld_in_countries:string,withheld_scope:string,extended_entities:struct<media:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string,id:bigint,id_str:string,media_url:string,media_url_https:string,source_status_id:bigint,source_status_id_str:string,type:string,sizes:struct<thumb:struct<w:int,h:int,resize:string>,large:struct<w:int,h:int,resize:string>,medium:struct<w:int,h:int,resize:string>,small:struct<w:int,h:int,resize:string>>,video_info:struct<aspect_ratio:array<int>,duration_millis:int,variants:array<struct<content_type:string,bitrate:int,url:string>>>>>>,extended_tweet:string,quoted_status_id:bigint,quoted_status_id_str:string,quoted_status:string>>
            - Name: source
              Type: string
            - Name: scopes
              Type: string
            - Name: text
              Type: string
            - Name: full_text
              Type: string
            - Name: display_text_range
              Type: array<int>
            - Name: place
              Type: struct<attributes:string,bounding_box:struct<coordinates:array<array<array<double>>>,type:string>,country:string,country_code:string,full_name:string,geometry:string,id:string,name:string,place_type:string,polylines:string,url:string>
            - Name: truncated
              Type: boolean
            - Name: user
              Type: struct<contributors_enabled:boolean,created_at:string,default_profile:boolean,default_profile_image:boolean,description:string,email:string,entities:struct<url:struct<hashtags:string,media:string,urls:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string>>,user_mentions:string>,description:struct<hashtags:string,media:string,urls:array<string>,user_mentions:string>>,favourites_count:int,follow_request_sent:boolean,followers_count:int,friends_count:int,geo_enabled:boolean,id:bigint,id_str:string,is_translator:boolean,lang:string,listed_count:int,location:string,name:string,notifications:boolean,profile_background_color:string,profile_background_image_url:string,profile_background_image_url_https:string,profile_background_tile:boolean,profile_banner_url:string,profile_image_url:string,profile_image_url_https:string,profile_link_color:string,profile_sidebar_border_color:string,profile_sidebar_fill_color:string,profile_text_color:string,profile_use_background_image:boolean,protected:boolean,screen_name:string,show_all_inline_media:boolean,status:string,statuses_count:int,time_zone:string,url:string,utc_offset:int,verified:boolean,withheld_in_countries:array<string>,withheld_scope:string>
            - Name: withheld_copyright
              Type: boolean
            - Name: withheld_in_countries
              Type: string
            - Name: withheld_scope
              Type: string
            - Name: extended_entities
              Type: struct<media:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string,id:bigint,id_str:string,media_url:string,media_url_https:string,source_status_id:bigint,source_status_id_str:string,type:string,sizes:struct<thumb:struct<w:int,h:int,resize:string>,large:struct<w:int,h:int,resize:string>,medium:struct<w:int,h:int,resize:string>,small:struct<w:int,h:int,resize:string>>,video_info:struct<aspect_ratio:array<int>,duration_millis:int,variants:array<struct<content_type:string,bitrate:int,url:string>>>>>>
            - Name: extended_tweet
              Type: string
            - Name: quoted_status_id
              Type: bigint
            - Name: quoted_status_id_str
              Type: string
            - Name: quoted_status
              Type: struct<coordinates:string,created_at:string,current_user_retweet:string,entities:struct<hashtags:array<struct<indices:array<int>,text:string>>,media:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string,id:bigint,id_str:string,media_url:string,media_url_https:string,source_status_id:bigint,source_status_id_str:string,type:string,sizes:struct<thumb:struct<w:int,h:int,resize:string>,large:struct<w:int,h:int,resize:string>,medium:struct<w:int,h:int,resize:string>,small:struct<w:int,h:int,resize:string>>,video_info:struct<aspect_ratio:array<int>,duration_millis:int,variants:string>>>,urls:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string>>,user_mentions:array<struct<indices:array<int>,id:bigint,id_str:string,name:string,screen_name:string>>>,favorite_count:int,favorited:boolean,filter_level:string,id:bigint,id_str:string,in_reply_to_screen_name:string,in_reply_to_status_id:bigint,in_reply_to_status_id_str:string,in_reply_to_user_id:bigint,in_reply_to_user_id_str:string,lang:string,possibly_sensitive:boolean,quote_count:int,reply_count:int,retweet_count:int,retweeted:boolean,retweeted_status:string,source:string,scopes:string,text:string,full_text:string,display_text_range:array<int>,place:struct<attributes:string,bounding_box:struct<coordinates:array<array<array<double>>>,type:string>,country:string,country_code:string,full_name:string,geometry:string,id:string,name:string,place_type:string,polylines:string,url:string>,truncated:boolean,user:struct<contributors_enabled:boolean,created_at:string,default_profile:boolean,default_profile_image:boolean,description:string,email:string,entities:struct<url:struct<hashtags:string,media:string,urls:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string>>,user_mentions:string>,description:struct<hashtags:string,media:string,urls:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string>>,user_mentions:string>>,favourites_count:int,follow_request_sent:boolean,followers_count:int,friends_count:int,geo_enabled:boolean,id:bigint,id_str:string,is_translator:boolean,lang:string,listed_count:int,location:string,name:string,notifications:boolean,profile_background_color:string,profile_background_image_url:string,profile_background_image_url_https:string,profile_background_tile:boolean,profile_banner_url:string,profile_image_url:string,profile_image_url_https:string,profile_link_color:string,profile_sidebar_border_color:string,profile_sidebar_fill_color:string,profile_text_color:string,profile_use_background_image:boolean,protected:boolean,screen_name:string,show_all_inline_media:boolean,status:string,statuses_count:int,time_zone:string,url:string,utc_offset:int,verified:boolean,withheld_in_countries:array<string>,withheld_scope:string>,withheld_copyright:boolean,withheld_in_countries:string,withheld_scope:string,extended_entities:struct<media:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string,id:bigint,id_str:string,media_url:string,media_url_https:string,source_status_id:bigint,source_status_id_str:string,type:string,sizes:struct<thumb:struct<w:int,h:int,resize:string>,large:struct<w:int,h:int,resize:string>,medium:struct<w:int,h:int,resize:string>,small:struct<w:int,h:int,resize:string>>,video_info:struct<aspect_ratio:array<int>,duration_millis:int,variants:array<struct<content_type:string,bitrate:int,url:string>>>>>>,extended_tweet:string,quoted_status_id:bigint,quoted_status_id_str:string,quoted_status:string>
          InputFormat: org.apache.hadoop.hive.ql.io.parquet.MapredParquetInputFormat
          OutputFormat: org.apache.hadoop.hive.ql.io.parquet.MapredParquetOutputFormat
          Location: !Sub
            - s3://${Bucket}/processed/timelines/
            - { Bucket: !Ref S3BucketName }
          Compressed: false
          NumberOfBuckets: -1
          SerdeInfo:
            SerializationLibrary: org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe
            Parameters:
              serialization.format: "1"
          BucketColumns: []
          SortColumns: []
          StoredAsSubDirectories: false
        PartitionKeys:
          - Name: user_id
            Type: bigint
          - Name: screen_name
            Type: string
        TableType: EXTERNAL_TABLE

  ParameterDDBParams:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /tndx/ddb/parameters
      Type: String
      Value: { Ref: ParamDDBParamTable }
      Description: tndx ddb parameters table
      Tags:
        Environment: { Ref: ParamEnvironment }
        Application: { Ref: ParamAppName }

  ParameterDDBRunner:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /tndx/ddb/runner
      Type: String
      Value: { Ref: ParamDDBRunnerTable }
      Description: tndx ddb parameters table
      Tags:
        Environment: { Ref: ParamEnvironment }
        Application: { Ref: ParamAppName }

  ParameterDeliveryStreamTimelines:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /tndx/delivery/timelines
      Type: String
      Value: { Ref: ParamDeliveryStreamTimelinesName }
      Description: tndx timeline delivery stream
      Tags:
        Environment: { Ref: ParamEnvironment }
        Application: { Ref: ParamAppName }

  ParameterRegion:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /tndx/region
      Type: String
      Value: { Ref: ParamRegion }
      Description: tndx region
      Tags:
        Environment: { Ref: ParamEnvironment }
        Application: { Ref: ParamAppName }

  ParameterS3Bucket:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /tndx/s3/bucket
      Type: String
      Value: { Ref: S3Bucket }
      Description: tndx S3 Bucket
      Tags:
        Environment: { Ref: ParamEnvironment }
        Application: { Ref: ParamAppName }

  ParameterSQSRunner:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /tndx/sqs/runner/url
      Type: String
      Value: { Ref: SQSTndxRunner }
      Description: SQS Runner URL
      Tags:
        nvironment: { Ref: ParamEnvironment }
        Application: { Ref: ParamAppName }

  ParameterTwitterAPIKey:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /tndx/twitter/api/key
      Type: String
      Value: { Ref: TwitterAPIKey }
      Description: Twitter API Key
      Tags:
        Environment: { Ref: ParamEnvironment }
        Application: { Ref: ParamAppName }

  ParameterTwitterAPISecret:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /tndx/twitter/api/secret
      Type: String
      Value: { Ref: TwitterAPISecret }
      Description: Twitter API Secret
      Tags:
        Environment: { Ref: ParamEnvironment }
        Application: { Ref: ParamAppName }

  PermissionForEventsToInvokeFunctionTndxRunnerFavorites:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref FunctionTndxRunner
      Action: "lambda:InvokeFunction"
      Principal: "events.amazonaws.com"
      SourceArn: !GetAtt EventTndxRunnerFavorites.Arn

  PermissionForEventsToInvokeFunctionTndxRunnerFollowers:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref FunctionTndxRunner
      Action: "lambda:InvokeFunction"
      Principal: "events.amazonaws.com"
      SourceArn: !GetAtt EventTndxRunnerFollowers.Arn

  PermissionForEventsToInvokeFunctionTndxRunnerFriends:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref FunctionTndxRunner
      Action: "lambda:InvokeFunction"
      Principal: "events.amazonaws.com"
      SourceArn: !GetAtt EventTndxRunnerFriends.Arn

  PermissionForEventsToInvokeFunctionTndxRunnerTimeline:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref FunctionTndxRunner
      Action: "lambda:InvokeFunction"
      Principal: "events.amazonaws.com"
      SourceArn: !GetAtt EventTndxRunnerTimeline.Arn

  PermissionForEventsToInvokeFunctionTndxRunnerUser:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref FunctionTndxRunner
      Action: "lambda:InvokeFunction"
      Principal: "events.amazonaws.com"
      SourceArn: !GetAtt EventTndxRunnerUser.Arn

  PolicyTndxDDBAccess:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyName: "TndxDDBAccess"
      Roles:
        - !Ref RoleLambdaExecution
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - dynamodb:GetItem
              - dynamodb:PutItem
              - dynamodb:Query
            Resource:
              - !GetAtt DDBParametersTable.Arn
              - !GetAtt DDBRunnerTable.Arn

  PolicyTndxS3Access:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyName: "TndxS3Access"
      Roles:
        - !Ref RoleLambdaExecution
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - s3:ListBucket
            Resource: !Sub
              - arn:aws:s3:::${Bucket}
              - { Bucket: !Ref S3BucketName }
          - Effect: Allow
            Action:
              - s3:PutObject
            Resource: !Sub
              - arn:aws:s3:::${Bucket}/*
              - { Bucket: !Ref S3BucketName }

  PolicyTndxSQSAccess:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyName: "TndxSQSAccess"
      Roles:
        - !Ref RoleLambdaExecution
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - sqs:SendMessage
              - sqs:ReceiveMessage
              - sqs:DeleteMessage
              - sqs:GetQueueAttributes
            Resource:
              - !GetAtt SQSTndxRunner.Arn

  PolicyTndxSSMAccess:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyName: "TndxParameterStoreAccess"
      Roles:
        - !Ref RoleLambdaExecution
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - "ssm:GetParameter*"
            Resource: !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/tndx*"

  RoleDelivery:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: ""
            Effect: Allow
            Principal:
              Service: firehose.amazonaws.com
            Action: "sts:AssumeRole"
            Condition:
              StringEquals:
                "sts:ExternalId": !Ref "AWS::AccountId"
      Path: "/"
      Policies:
        - PolicyName: firehose_delivery_tndx_policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - "s3:AbortMultipartUpload"
                  - "s3:GetBucketLocation"
                  - "s3:GetObject"
                  - "s3:ListBucket"
                  - "s3:ListBucketMultipartUploads"
                  - "s3:PutObject"
                Resource:
                  - !Join
                    - ""
                    - - "arn:aws:s3:::"
                      - !Ref S3Bucket
                  - !Join
                    - ""
                    - - "arn:aws:s3:::"
                      - !Ref S3Bucket
                      - "/*"
              - Effect: Allow
                Action: "glue:GetTableVersions"
                Resource: "*"
              - Effect: Allow
                Action:
                  - "logs:PutLogEvents"
                  - "logs:Create*"
                Resource:
                  - !Join
                    - ""
                    - - "arn:aws:logs:"
                      - !Ref "AWS::Region"
                      - ":"
                      - !Ref "AWS::AccountId"
                      - "log-group:/aws/kinesisfirehose/KDF-"
                      - !Ref GlueTableTndxTimelines
                      - ":log-stream:*"

  RoleLambdaExecution:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - "lambda.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
      Tags:
        - Key: "Environment"
          Value: { Ref: ParamEnvironment }
        - Key: "Application"
          Value: { Ref: ParamAppName }

  S3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      BucketName: { Ref: S3BucketName }
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: "Environment"
          Value: { Ref: ParamEnvironment }
        - Key: "Application"
          Value: { Ref: ParamAppName }

  SQSTndxRunner:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: { Ref: SQSName }
      KmsMasterKeyId: alias/aws/sqs
      VisibilityTimeout: 60
      Tags:
        - Key: "Environment"
          Value: { Ref: ParamEnvironment }
        - Key: "Application"
          Value: { Ref: ParamAppName }
