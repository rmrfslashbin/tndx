AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: "tndx: the twitter ndx"

Parameters:
  ParamAppName:
    Type: String
    Default: tndx
    Description: Application/stack name.

  ParamDDBTablePrefix:
    Type: String
    Default: tndx-rmrfslashbin-
    Description: DDB table to favorites.

  ParamEnvironment:
    Type: String
    Default: prod
    AllowedValues:
      - dev
      - staging
      - prod
    Description: Environment for deployment.

  ParamInstanceName:
    Type: String
    Default: rmrfslashbin
    Description: Instance name.

  ParamRegion:
    Type: String
    Default: us-east-2
    AllowedValues:
      - us-east-1
      - us-east-2
      - us-west-1
      - us-west-2
    Description: The AWS Region for deployment.

  ParamRunnerName:
    Type: String
    Default: tndx-rmrfslashbin-01
    Description: Name of tndx runner.

  S3BucketName:
    Type: String
    Default: is-tndx-rmrfslashbin-us-east-2
    Description: Priamry S3 bucket.

  TwitterAPIKey:
    Type: String
    Default: rmrfslashbin-twitter-api-key
    Description: Twitter API key.

  TwitterAPISecret:
    Type: String
    Default: rmrfslashbin-twitter-api-secret
    Description: Twitter API secret.

Globals:
  Function:
    Timeout: 60

Resources:
  DDBFavoritesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${ParamDDBTablePrefix}favorites"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: UserID
          AttributeType: N
        - AttributeName: TweetID
          AttributeType: N
      KeySchema:
        - AttributeName: UserID
          KeyType: HASH
        - AttributeName: TweetID
          KeyType: RANGE
      Tags:
        - Key: "Environment"
          Value: { Ref: ParamEnvironment }
        - Key: "Application"
          Value: { Ref: ParamAppName }
        - Key: "Instance"
          Value: { Ref: ParamInstanceName }

  DDBFollowersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${ParamDDBTablePrefix}followers"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: UserID
          AttributeType: N
        - AttributeName: FollowerID
          AttributeType: N
      KeySchema:
        - AttributeName: UserID
          KeyType: HASH
        - AttributeName: FollowerID
          KeyType: RANGE
      Tags:
        - Key: "Environment"
          Value: { Ref: ParamEnvironment }
        - Key: "Application"
          Value: { Ref: ParamAppName }
        - Key: "Instance"
          Value: { Ref: ParamInstanceName }

  DDBFriendsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${ParamDDBTablePrefix}friends"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: UserID
          AttributeType: N
        - AttributeName: FriendID
          AttributeType: N
      KeySchema:
        - AttributeName: UserID
          KeyType: HASH
        - AttributeName: FriendID
          KeyType: RANGE
      Tags:
        - Key: "Environment"
          Value: { Ref: ParamEnvironment }
        - Key: "Application"
          Value: { Ref: ParamAppName }
        - Key: "Instance"
          Value: { Ref: ParamInstanceName }

  DDBMediaTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${ParamDDBTablePrefix}media"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: TweetID
          AttributeType: N
        - AttributeName: UserID
          AttributeType: N
        - AttributeName: S3Key
          AttributeType: S
      KeySchema:
        - AttributeName: TweetID
          KeyType: HASH
        - AttributeName: S3Key
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: !Sub "${ParamDDBTablePrefix}media-gsi-userid"
          KeySchema:
            - AttributeName: UserID
              KeyType: HASH
            - AttributeName: S3Key
              KeyType: RANGE
          Projection:
            ProjectionType: KEYS_ONLY
      Tags:
        - Key: "Environment"
          Value: { Ref: ParamEnvironment }
        - Key: "Application"
          Value: { Ref: ParamAppName }
        - Key: "Instance"
          Value: { Ref: ParamInstanceName }

  DDBParametersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${ParamDDBTablePrefix}parameters"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: UserID
          AttributeType: N
        - AttributeName: Domain
          AttributeType: S
      KeySchema:
        - AttributeName: UserID
          KeyType: HASH
        - AttributeName: Domain
          KeyType: RANGE
      Tags:
        - Key: "Environment"
          Value: { Ref: ParamEnvironment }
        - Key: "Application"
          Value: { Ref: ParamAppName }
        - Key: "Instance"
          Value: { Ref: ParamInstanceName }

  DDBRunnerTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${ParamDDBTablePrefix}runners"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: RunnerName
          AttributeType: S
        - AttributeName: UserID
          AttributeType: N
      KeySchema:
        - AttributeName: RunnerName
          KeyType: HASH
        - AttributeName: UserID
          KeyType: RANGE
      Tags:
        - Key: "Environment"
          Value: { Ref: ParamEnvironment }
        - Key: "Application"
          Value: { Ref: ParamAppName }
        - Key: "Instance"
          Value: { Ref: ParamInstanceName }

  DeliveryStreamTweets:
    Type: AWS::KinesisFirehose::DeliveryStream
    Properties:
      DeliveryStreamType: DirectPut
      Tags:
        - Key: "Environment"
          Value: { Ref: ParamEnvironment }
        - Key: "Application"
          Value: { Ref: ParamAppName }
        - Key: "Instance"
          Value: { Ref: ParamInstanceName }
      ExtendedS3DestinationConfiguration:
        RoleARN: !GetAtt RoleDelivery.Arn
        BucketARN: !GetAtt S3Bucket.Arn
        Prefix: "processed/tweets/year=!{partitionKeyFromQuery:year}/month=!{partitionKeyFromQuery:month}/"
        ErrorOutputPrefix: "errors/tweets/"
        BufferingHints:
          SizeInMBs: 128
          IntervalInSeconds: 300
        CompressionFormat: UNCOMPRESSED
        EncryptionConfiguration:
          NoEncryptionConfig: NoEncryption
        CloudWatchLoggingOptions:
          Enabled: true
          LogGroupName: !Sub "KDF-${GlueTableTndxTweets}"
          LogStreamName: S3Delivery
        S3BackupMode: Enabled
        S3BackupConfiguration:
          RoleARN: !GetAtt RoleDelivery.Arn
          BucketARN: !GetAtt S3Bucket.Arn
          Prefix: "backup/tweets/"
          ErrorOutputPrefix: "backup/tweets/errors/"
          BufferingHints:
            SizeInMBs: 128
            IntervalInSeconds: 300
          CompressionFormat: GZIP
          EncryptionConfiguration:
            NoEncryptionConfig: NoEncryption
          CloudWatchLoggingOptions:
            Enabled: true
            LogGroupName: !Sub "KDF-Backup-${GlueTableTndxTweets}"
            LogStreamName: S3Delivery
        DynamicPartitioningConfiguration:
          Enabled: true
          RetryOptions:
            DurationInSeconds: 300
        ProcessingConfiguration:
          Enabled: true
          Processors:
            - Type: MetadataExtraction
              Parameters:
                - ParameterName: MetadataExtractionQuery
                  ParameterValue: '{year : (.created_at | tonumber | strftime ("%Y")), month : (.created_at | tonumber | strftime ("%m"))}'
                - ParameterName: JsonParsingEngine
                  ParameterValue: JQ-1.6
        DataFormatConversionConfiguration:
          SchemaConfiguration:
            CatalogId: !Ref AWS::AccountId
            RoleARN: !GetAtt RoleDelivery.Arn
            DatabaseName: !Ref GlueDatabaseTndx
            TableName: !Ref GlueTableTndxTweets
            Region: !Ref AWS::Region
            VersionId: LATEST
          InputFormatConfiguration:
            Deserializer:
              OpenXJsonSerDe: {}
          OutputFormatConfiguration:
            Serializer:
              OrcSerDe:
                Compression: SNAPPY
          Enabled: True

  EventTndxRunnerFavorites:
    Type: AWS::Events::Rule
    Properties:
      Description: Run a tndx runner for favorites
      ScheduleExpression: "rate(15 minutes)"
      State: DISABLED
      Targets:
        - Arn: !GetAtt FunctionTndxRunner.Arn
          Id: TargetFunctionTndxRunnerFavorites
          Input: !Sub |
            {
              "runner_name": "${ParamRunnerName}",
              "function": "favorites",
              "region": "${ParamRegion}",
              "ddb_table_prefix": "${ParameterDDBTablePrefix}",
              "delivery_stream": "${ParameterDeliveryStreamTweets}",
              "sqs_runner_url": "${ParameterSQSRunner}",
              "s3_bucket": "${ParameterS3Bucket}",
              "twitter_api_key": "${ParameterTwitterAPIKey}",
              "twitter_api_secret": "${ParameterTwitterAPISecret}"
            }

  EventTndxRunnerFollowers:
    Type: AWS::Events::Rule
    Properties:
      Description: Run a tndx runner for followers
      ScheduleExpression: "rate(60 minutes)"
      State: DISABLED
      Targets:
        - Arn: !GetAtt FunctionTndxRunner.Arn
          Id: TargetFunctionTndxRunnerFollowers
          Input: !Sub |
            {
              "runner_name": "${ParamRunnerName}",
              "function": "followers",
              "region": "${ParamRegion}",
              "ddb_table_prefix": "${ParameterDDBTablePrefix}",
              "delivery_stream": "${ParameterDeliveryStreamTweets}",
              "sqs_runner_url": "${ParameterSQSRunner}",
              "s3_bucket": "${ParameterS3Bucket}",
              "twitter_api_key": "${ParameterTwitterAPIKey}",
              "twitter_api_secret": "${ParameterTwitterAPISecret}"
            }

  EventTndxRunnerFriends:
    Type: AWS::Events::Rule
    Properties:
      Description: Run a tndx runner for friends
      ScheduleExpression: "rate(60 minutes)"
      State: DISABLED
      Targets:
        - Arn: !GetAtt FunctionTndxRunner.Arn
          Id: TargetFunctionTndxRunnerFriends
          Input: !Sub |
            {
              "runner_name": "${ParamRunnerName}",
              "function": "friends",
              "region": "${ParamRegion}",
              "ddb_table_prefix": "${ParameterDDBTablePrefix}",
              "delivery_stream": "${ParameterDeliveryStreamTweets}",
              "sqs_runner_url": "${ParameterSQSRunner}",
              "s3_bucket": "${ParameterS3Bucket}",
              "twitter_api_key": "${ParameterTwitterAPIKey}",
              "twitter_api_secret": "${ParameterTwitterAPISecret}"
            }

  EventTndxRunnerTimeline:
    Type: AWS::Events::Rule
    Properties:
      Description: Run a tndx runner for timelines
      ScheduleExpression: "rate(5 minutes)"
      State: DISABLED
      Targets:
        - Arn: !GetAtt FunctionTndxRunner.Arn
          Id: TargetFunctionTndxRunnerTimeline
          Input: !Sub |
            {
              "runner_name": "${ParamRunnerName}",
              "function": "timeline",
              "region": "${ParamRegion}",
              "ddb_table_prefix": "${ParameterDDBTablePrefix}",
              "delivery_stream": "${ParameterDeliveryStreamTweets}",
              "sqs_runner_url": "${ParameterSQSRunner}",
              "s3_bucket": "${ParameterS3Bucket}",
              "twitter_api_key": "${ParameterTwitterAPIKey}",
              "twitter_api_secret": "${ParameterTwitterAPISecret}"
            }

  EventTndxRunnerUser:
    Type: AWS::Events::Rule
    Properties:
      Description: Run a tndx runner for user
      ScheduleExpression: "rate(12 hours)"
      State: DISABLED
      Targets:
        - Arn: !GetAtt FunctionTndxRunner.Arn
          Id: TargetFunctionTndxRunnerUser
          Input: !Sub |
            {
              "runner_name": "${ParamRunnerName}",
              "function": "user",
              "region": "${ParamRegion}",
              "ddb_table_prefix": "${ParameterDDBTablePrefix}",
              "delivery_stream": "${ParameterDeliveryStreamTweets}",
              "sqs_runner_url": "${ParameterSQSRunner}",
              "s3_bucket": "${ParameterS3Bucket}",
              "twitter_api_key": "${ParameterTwitterAPIKey}",
              "twitter_api_secret": "${ParameterTwitterAPISecret}"
            }

  FunctionTndxConfigWriter:
    Type: AWS::Serverless::Function
    Properties:
      Description: Tndx config maker
      FunctionName: !Sub ${ParamAppName}-${ParamInstanceName}-configMaker-${ParamEnvironment}
      CodeUri: ../bin/tndx-lambda-config-maker
      Handler: bootstrap
      Runtime: provided.al2
      Architectures: [arm64]
      Role: !GetAtt RoleLambdaExecution.Arn
      Environment:
        Variables:
          REGION: { Ref: AWS::Region }
          PROFILE: "you-profile-name"
          DDB_TABLE_PREFIX: { Ref: ParameterDDBTablePrefix }
          TWITTER_API_KEY: { Ref: ParameterTwitterAPIKey }
          TWITTER_API_SECRET: { Ref: ParameterTwitterAPISecret }
      Tags:
        Environment: { Ref: ParamEnvironment }
        Application: { Ref: ParamAppName }
        Instance: { Ref: ParamInstanceName }

  FunctionTndxProcessor:
    Type: AWS::Serverless::Function
    Properties:
      Description: Tndx Processor
      FunctionName: !Sub ${ParamAppName}-${ParamInstanceName}-processor-${ParamEnvironment}
      CodeUri: ../bin/tndx-lambda-processor
      Handler: bootstrap
      Runtime: provided.al2
      Architectures: [arm64]
      Role: !GetAtt RoleLambdaExecution.Arn
      Tags:
        Environment: { Ref: ParamEnvironment }
        Application: { Ref: ParamAppName }
        Instance: { Ref: ParamInstanceName }
      Events:
        EventSQSTndxRunnerToFunctionTndxProcessor:
          Type: SQS
          Properties:
            Queue: !GetAtt SQSTndxRunner.Arn
            Enabled: true

  FuntionTndxRekognition:
    Type: AWS::Serverless::Function
    Properties:
      Description: Tndx Rekognition
      FunctionName: !Sub ${ParamAppName}-${ParamInstanceName}-rekognition-${ParamEnvironment}
      CodeUri: ../bin/tndx-lambda-rekognition
      Handler: bootstrap
      Runtime: provided.al2
      Architectures: [arm64]
      Role: !GetAtt RoleLambdaExecution.Arn
      Tags:
        Environment: { Ref: ParamEnvironment }
        Application: { Ref: ParamAppName }
        Instance: { Ref: ParamInstanceName }
      Environment:
        Variables:
          DDB_TABLE_PREFIX: { Ref: ParameterDDBTablePrefix }
      Events:
        EventS3TndxMediaToFunctionTndxRekognition:
          Type: S3
          Properties:
            Bucket: { Ref: S3Bucket }
            Events:
              - s3:ObjectCreated:*
              - s3:ObjectRemoved:*
            Filter:
              S3Key:
                Rules:
                  - Name: prefix
                    Value: media/

  FunctionTndxRunner:
    Type: AWS::Serverless::Function
    Properties:
      Description: Runner function
      FunctionName: !Sub ${ParamAppName}-${ParamInstanceName}-runner-${ParamEnvironment}
      CodeUri: ../bin/tndx-lambda-runner
      Handler: bootstrap
      Runtime: provided.al2
      Architectures: [arm64]
      Role: !GetAtt RoleLambdaExecution.Arn
      Tags:
        Environment: { Ref: ParamEnvironment }
        Application: { Ref: ParamAppName }
        Instance: { Ref: ParamInstanceName }

  GlueCrawlerTweets:
    Type: AWS::Glue::Crawler
    Properties:
      Configuration: '{"Version":1.0,"Grouping":{"TableGroupingPolicy":"CombineCompatibleSchemas"}}'
      Description: Crawler for tweets
      Name: !Sub "tndx-${ParamInstanceName}-tweets"
      RecrawlPolicy:
        RecrawlBehavior: CRAWL_EVERYTHING
      Role: !GetAtt RoleGlueCrawler.Arn
      SchemaChangePolicy:
        DeleteBehavior: LOG
        UpdateBehavior: UPDATE_IN_DATABASE
      Targets:
        CatalogTargets:
          - DatabaseName: { Ref: GlueDatabaseTndx }
            Tables:
              - { Ref: GlueTableTndxTweets }

  GlueDatabaseTndx:
    Type: AWS::Glue::Database
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseInput:
        Description: !Sub "tndx ${ParamInstanceName} database"
        Name: !Sub "tndx_${ParamInstanceName}"

  GlueTableTndxTweets:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref GlueDatabaseTndx
      TableInput:
        Name: "tweets"
        Description: !Sub "tndx ${ParamInstanceName} tweets table"
        StorageDescriptor:
          Columns:
            - Name: coordinates
              Type: struct<coordinates:array<double>,type:string>
            - Name: created_at
              Type: string
            - Name: current_user_retweet
              Type: string
            - Name: entities
              Type: struct<hashtags:array<struct<indices:array<int>,text:string>>,media:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string,id:bigint,id_str:string,media_url:string,media_url_https:string,source_status_id:bigint,source_status_id_str:string,type:string,sizes:struct<thumb:struct<w:int,h:int,resize:string>,large:struct<w:int,h:int,resize:string>,medium:struct<w:int,h:int,resize:string>,small:struct<w:int,h:int,resize:string>>,video_info:struct<aspect_ratio:array<int>,duration_millis:int,variants:string>>>,urls:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string>>,user_mentions:array<struct<indices:array<int>,id:bigint,id_str:string,name:string,screen_name:string>>>
            - Name: favorite_count
              Type: int
            - Name: favorited
              Type: boolean
            - Name: filter_level
              Type: string
            - Name: id
              Type: bigint
            - Name: id_str
              Type: string
            - Name: in_reply_to_screen_name
              Type: string
            - Name: in_reply_to_status_id
              Type: bigint
            - Name: in_reply_to_status_id_str
              Type: string
            - Name: in_reply_to_user_id
              Type: bigint
            - Name: in_reply_to_user_id_str
              Type: string
            - Name: lang
              Type: string
            - Name: possibly_sensitive
              Type: boolean
            - Name: quote_count
              Type: bigint
            - Name: reply_count
              Type: int
            - Name: retweet_count
              Type: int
            - Name: retweeted
              Type: boolean
            - Name: retweeted_status
              Type: struct<coordinates:string,created_at:string,current_user_retweet:string,entities:struct<hashtags:array<struct<indices:array<int>,text:string>>,media:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string,id:bigint,id_str:string,media_url:string,media_url_https:string,source_status_id:bigint,source_status_id_str:string,type:string,sizes:struct<thumb:struct<w:int,h:int,resize:string>,large:struct<w:int,h:int,resize:string>,medium:struct<w:int,h:int,resize:string>,small:struct<w:int,h:int,resize:string>>,video_info:struct<aspect_ratio:array<int>,duration_millis:int,variants:string>>>,urls:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string>>,user_mentions:array<struct<indices:array<int>,id:bigint,id_str:string,name:string,screen_name:string>>>,favorite_count:int,favorited:boolean,filter_level:string,id:bigint,id_str:string,in_reply_to_screen_name:string,in_reply_to_status_id:bigint,in_reply_to_status_id_str:string,in_reply_to_user_id:bigint,in_reply_to_user_id_str:string,lang:string,possibly_sensitive:boolean,quote_count:int,reply_count:int,retweet_count:int,retweeted:boolean,retweeted_status:string,source:string,scopes:string,text:string,full_text:string,display_text_range:array<int>,place:struct<attributes:string,bounding_box:struct<coordinates:array<array<array<double>>>,type:string>,country:string,country_code:string,full_name:string,geometry:string,id:string,name:string,place_type:string,polylines:string,url:string>,truncated:boolean,user:struct<contributors_enabled:boolean,created_at:string,default_profile:boolean,default_profile_image:boolean,description:string,email:string,entities:struct<url:struct<hashtags:string,media:string,urls:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string>>,user_mentions:string>,description:struct<hashtags:string,media:string,urls:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string>>,user_mentions:string>>,favourites_count:int,follow_request_sent:boolean,followers_count:int,friends_count:int,geo_enabled:boolean,id:bigint,id_str:string,is_translator:boolean,lang:string,listed_count:int,location:string,name:string,notifications:boolean,profile_background_color:string,profile_background_image_url:string,profile_background_image_url_https:string,profile_background_tile:boolean,profile_banner_url:string,profile_image_url:string,profile_image_url_https:string,profile_link_color:string,profile_sidebar_border_color:string,profile_sidebar_fill_color:string,profile_text_color:string,profile_use_background_image:boolean,protected:boolean,screen_name:string,show_all_inline_media:boolean,status:string,statuses_count:int,time_zone:string,url:string,utc_offset:int,verified:boolean,withheld_in_countries:array<string>,withheld_scope:string>,withheld_copyright:boolean,withheld_in_countries:string,withheld_scope:string,extended_entities:struct<media:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string,id:bigint,id_str:string,media_url:string,media_url_https:string,source_status_id:bigint,source_status_id_str:string,type:string,sizes:struct<thumb:struct<w:int,h:int,resize:string>,large:struct<w:int,h:int,resize:string>,medium:struct<w:int,h:int,resize:string>,small:struct<w:int,h:int,resize:string>>,video_info:struct<aspect_ratio:array<int>,duration_millis:int,variants:array<struct<content_type:string,bitrate:int,url:string>>>>>>,extended_tweet:string,quoted_status_id:bigint,quoted_status_id_str:string,quoted_status:struct<coordinates:string,created_at:string,current_user_retweet:string,entities:struct<hashtags:array<struct<indices:array<int>,text:string>>,media:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string,id:bigint,id_str:string,media_url:string,media_url_https:string,source_status_id:bigint,source_status_id_str:string,type:string,sizes:struct<thumb:struct<w:int,h:int,resize:string>,large:struct<w:int,h:int,resize:string>,medium:struct<w:int,h:int,resize:string>,small:struct<w:int,h:int,resize:string>>,video_info:struct<aspect_ratio:array<int>,duration_millis:int,variants:string>>>,urls:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string>>,user_mentions:array<struct<indices:array<int>,id:bigint,id_str:string,name:string,screen_name:string>>>,favorite_count:int,favorited:boolean,filter_level:string,id:bigint,id_str:string,in_reply_to_screen_name:string,in_reply_to_status_id:bigint,in_reply_to_status_id_str:string,in_reply_to_user_id:bigint,in_reply_to_user_id_str:string,lang:string,possibly_sensitive:boolean,quote_count:int,reply_count:int,retweet_count:int,retweeted:boolean,retweeted_status:string,source:string,scopes:string,text:string,full_text:string,display_text_range:array<int>,place:struct<attributes:string,bounding_box:struct<coordinates:array<array<array<double>>>,type:string>,country:string,country_code:string,full_name:string,geometry:string,id:string,name:string,place_type:string,polylines:string,url:string>,truncated:boolean,user:struct<contributors_enabled:boolean,created_at:string,default_profile:boolean,default_profile_image:boolean,description:string,email:string,entities:struct<url:struct<hashtags:string,media:string,urls:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string>>,user_mentions:string>,description:struct<hashtags:string,media:string,urls:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string>>,user_mentions:string>>,favourites_count:int,follow_request_sent:boolean,followers_count:int,friends_count:int,geo_enabled:boolean,id:bigint,id_str:string,is_translator:boolean,lang:string,listed_count:int,location:string,name:string,notifications:boolean,profile_background_color:string,profile_background_image_url:string,profile_background_image_url_https:string,profile_background_tile:boolean,profile_banner_url:string,profile_image_url:string,profile_image_url_https:string,profile_link_color:string,profile_sidebar_border_color:string,profile_sidebar_fill_color:string,profile_text_color:string,profile_use_background_image:boolean,protected:boolean,screen_name:string,show_all_inline_media:boolean,status:string,statuses_count:int,time_zone:string,url:string,utc_offset:int,verified:boolean,withheld_in_countries:array<string>,withheld_scope:string>,withheld_copyright:boolean,withheld_in_countries:string,withheld_scope:string,extended_entities:struct<media:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string,id:bigint,id_str:string,media_url:string,media_url_https:string,source_status_id:bigint,source_status_id_str:string,type:string,sizes:struct<thumb:struct<w:int,h:int,resize:string>,large:struct<w:int,h:int,resize:string>,medium:struct<w:int,h:int,resize:string>,small:struct<w:int,h:int,resize:string>>,video_info:struct<aspect_ratio:array<int>,duration_millis:int,variants:array<struct<content_type:string,bitrate:int,url:string>>>>>>,extended_tweet:string,quoted_status_id:bigint,quoted_status_id_str:string,quoted_status:string>>
            - Name: source
              Type: string
            - Name: scopes
              Type: string
            - Name: text
              Type: string
            - Name: full_text
              Type: string
            - Name: display_text_range
              Type: array<int>
            - Name: place
              Type: struct<attributes:string,bounding_box:struct<coordinates:array<array<array<double>>>,type:string>,country:string,country_code:string,full_name:string,geometry:string,id:string,name:string,place_type:string,polylines:string,url:string>
            - Name: truncated
              Type: boolean
            - Name: user
              Type: struct<contributors_enabled:boolean,created_at:string,default_profile:boolean,default_profile_image:boolean,description:string,email:string,entities:struct<url:struct<hashtags:string,media:string,urls:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string>>,user_mentions:string>,description:struct<hashtags:string,media:string,urls:array<string>,user_mentions:string>>,favourites_count:int,follow_request_sent:boolean,followers_count:int,friends_count:int,geo_enabled:boolean,id:bigint,id_str:string,is_translator:boolean,lang:string,listed_count:int,location:string,name:string,notifications:boolean,profile_background_color:string,profile_background_image_url:string,profile_background_image_url_https:string,profile_background_tile:boolean,profile_banner_url:string,profile_image_url:string,profile_image_url_https:string,profile_link_color:string,profile_sidebar_border_color:string,profile_sidebar_fill_color:string,profile_text_color:string,profile_use_background_image:boolean,protected:boolean,screen_name:string,show_all_inline_media:boolean,status:string,statuses_count:int,time_zone:string,url:string,utc_offset:int,verified:boolean,withheld_in_countries:array<string>,withheld_scope:string>
            - Name: withheld_copyright
              Type: boolean
            - Name: withheld_in_countries
              Type: string
            - Name: withheld_scope
              Type: string
            - Name: extended_entities
              Type: struct<media:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string,id:bigint,id_str:string,media_url:string,media_url_https:string,source_status_id:bigint,source_status_id_str:string,type:string,sizes:struct<thumb:struct<w:int,h:int,resize:string>,large:struct<w:int,h:int,resize:string>,medium:struct<w:int,h:int,resize:string>,small:struct<w:int,h:int,resize:string>>,video_info:struct<aspect_ratio:array<int>,duration_millis:int,variants:array<struct<content_type:string,bitrate:int,url:string>>>>>>
            - Name: extended_tweet
              Type: string
            - Name: quoted_status_id
              Type: bigint
            - Name: quoted_status_id_str
              Type: string
            - Name: quoted_status
              Type: struct<coordinates:string,created_at:string,current_user_retweet:string,entities:struct<hashtags:array<struct<indices:array<int>,text:string>>,media:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string,id:bigint,id_str:string,media_url:string,media_url_https:string,source_status_id:bigint,source_status_id_str:string,type:string,sizes:struct<thumb:struct<w:int,h:int,resize:string>,large:struct<w:int,h:int,resize:string>,medium:struct<w:int,h:int,resize:string>,small:struct<w:int,h:int,resize:string>>,video_info:struct<aspect_ratio:array<int>,duration_millis:int,variants:string>>>,urls:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string>>,user_mentions:array<struct<indices:array<int>,id:bigint,id_str:string,name:string,screen_name:string>>>,favorite_count:int,favorited:boolean,filter_level:string,id:bigint,id_str:string,in_reply_to_screen_name:string,in_reply_to_status_id:bigint,in_reply_to_status_id_str:string,in_reply_to_user_id:bigint,in_reply_to_user_id_str:string,lang:string,possibly_sensitive:boolean,quote_count:int,reply_count:int,retweet_count:int,retweeted:boolean,retweeted_status:string,source:string,scopes:string,text:string,full_text:string,display_text_range:array<int>,place:struct<attributes:string,bounding_box:struct<coordinates:array<array<array<double>>>,type:string>,country:string,country_code:string,full_name:string,geometry:string,id:string,name:string,place_type:string,polylines:string,url:string>,truncated:boolean,user:struct<contributors_enabled:boolean,created_at:string,default_profile:boolean,default_profile_image:boolean,description:string,email:string,entities:struct<url:struct<hashtags:string,media:string,urls:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string>>,user_mentions:string>,description:struct<hashtags:string,media:string,urls:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string>>,user_mentions:string>>,favourites_count:int,follow_request_sent:boolean,followers_count:int,friends_count:int,geo_enabled:boolean,id:bigint,id_str:string,is_translator:boolean,lang:string,listed_count:int,location:string,name:string,notifications:boolean,profile_background_color:string,profile_background_image_url:string,profile_background_image_url_https:string,profile_background_tile:boolean,profile_banner_url:string,profile_image_url:string,profile_image_url_https:string,profile_link_color:string,profile_sidebar_border_color:string,profile_sidebar_fill_color:string,profile_text_color:string,profile_use_background_image:boolean,protected:boolean,screen_name:string,show_all_inline_media:boolean,status:string,statuses_count:int,time_zone:string,url:string,utc_offset:int,verified:boolean,withheld_in_countries:array<string>,withheld_scope:string>,withheld_copyright:boolean,withheld_in_countries:string,withheld_scope:string,extended_entities:struct<media:array<struct<indices:array<int>,display_url:string,expanded_url:string,url:string,id:bigint,id_str:string,media_url:string,media_url_https:string,source_status_id:bigint,source_status_id_str:string,type:string,sizes:struct<thumb:struct<w:int,h:int,resize:string>,large:struct<w:int,h:int,resize:string>,medium:struct<w:int,h:int,resize:string>,small:struct<w:int,h:int,resize:string>>,video_info:struct<aspect_ratio:array<int>,duration_millis:int,variants:array<struct<content_type:string,bitrate:int,url:string>>>>>>,extended_tweet:string,quoted_status_id:bigint,quoted_status_id_str:string,quoted_status:string>
          InputFormat: org.apache.hadoop.hive.ql.io.orc.OrcInputFormat
          OutputFormat: org.apache.hadoop.hive.ql.io.orc.OrcOutputFormat
          Location: !Sub "s3://${S3Bucket}/processed/tweets/"
          Compressed: false
          NumberOfBuckets: -1
          SerdeInfo:
            SerializationLibrary: org.apache.hadoop.hive.ql.io.orc.OrcSerde
          BucketColumns: []
          SortColumns: []
          StoredAsSubDirectories: false
        PartitionKeys:
          - Name: year
            Type: int
          - Name: month
            Type: int
        TableType: EXTERNAL_TABLE

  ParameterDDBTablePrefix:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/tndx/${ParamInstanceName}/ddb/table-prefix"
      Type: String
      Value: { Ref: ParamDDBTablePrefix }
      Description: !Sub "tndx ${ParamInstanceName} ddb table prefix"
      Tags:
        Environment: { Ref: ParamEnvironment }
        Application: { Ref: ParamAppName }
        Instance: { Ref: ParamInstanceName }

  ParameterDeliveryStreamTweets:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/tndx/${ParamInstanceName}/delivery/tweets"
      Type: String
      Value: { Ref: DeliveryStreamTweets }
      Description: !Sub "tndx ${ParamInstanceName} tweet delivery stream"
      Tags:
        Environment: { Ref: ParamEnvironment }
        Application: { Ref: ParamAppName }
        Instance: { Ref: ParamInstanceName }

  ParameterGlueTweetsCrawlerName:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/tndx/${ParamInstanceName}/glue/tweets/crawler-name"
      Type: String
      Value: { Ref: GlueCrawlerTweets }
      Description: !Sub "tndx ${ParamInstanceName} tweet glue crawler name"
      Tags:
        Environment: { Ref: ParamEnvironment }
        Application: { Ref: ParamAppName }
        Instance: { Ref: ParamInstanceName }

  ParameterRegion:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/tndx/${ParamInstanceName}/region"
      Type: String
      Value: { Ref: ParamRegion }
      Description: !Sub "tndx ${ParamInstanceName} region"
      Tags:
        Environment: { Ref: ParamEnvironment }
        Application: { Ref: ParamAppName }
        Instance: { Ref: ParamInstanceName }

  ParameterS3Bucket:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/tndx/${ParamInstanceName}/s3/bucket"
      Type: String
      Value: { Ref: S3Bucket }
      Description: !Sub "tndx ${ParamInstanceName} S3 Bucket"
      Tags:
        Environment: { Ref: ParamEnvironment }
        Application: { Ref: ParamAppName }
        Instance: { Ref: ParamInstanceName }

  ParameterSQSRunner:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/tndx/${ParamInstanceName}/sqs/runner/url"
      Type: String
      Value: { Ref: SQSTndxRunner }
      Description: !Sub "tndx ${ParamInstanceName} Runner URL"
      Tags:
        nvironment: { Ref: ParamEnvironment }
        Application: { Ref: ParamAppName }
        Instance: { Ref: ParamInstanceName }

  ParameterTwitterAPIKey:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/tndx/${ParamInstanceName}/twitter/api/key"
      Type: String
      Value: { Ref: TwitterAPIKey }
      Description: !Sub "tndx ${ParamInstanceName} Twitter API Key"
      Tags:
        Environment: { Ref: ParamEnvironment }
        Application: { Ref: ParamAppName }
        Instance: { Ref: ParamInstanceName }

  ParameterTwitterAPISecret:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/tndx/${ParamInstanceName}/twitter/api/secret"
      Type: String
      Value: { Ref: TwitterAPISecret }
      Description: !Sub "tndx ${ParamInstanceName} Twitter API Secret"
      Tags:
        Environment: { Ref: ParamEnvironment }
        Application: { Ref: ParamAppName }
        Instance: { Ref: ParamInstanceName }

  PermissionForEventsToInvokeFunctionTndxRunnerFavorites:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref FunctionTndxRunner
      Action: "lambda:InvokeFunction"
      Principal: "events.amazonaws.com"
      SourceArn: !GetAtt EventTndxRunnerFavorites.Arn

  PermissionForEventsToInvokeFunctionTndxRunnerFollowers:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref FunctionTndxRunner
      Action: "lambda:InvokeFunction"
      Principal: "events.amazonaws.com"
      SourceArn: !GetAtt EventTndxRunnerFollowers.Arn

  PermissionForEventsToInvokeFunctionTndxRunnerFriends:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref FunctionTndxRunner
      Action: "lambda:InvokeFunction"
      Principal: "events.amazonaws.com"
      SourceArn: !GetAtt EventTndxRunnerFriends.Arn

  PermissionForEventsToInvokeFunctionTndxRunnerTimeline:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref FunctionTndxRunner
      Action: "lambda:InvokeFunction"
      Principal: "events.amazonaws.com"
      SourceArn: !GetAtt EventTndxRunnerTimeline.Arn

  PermissionForEventsToInvokeFunctionTndxRunnerUser:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref FunctionTndxRunner
      Action: "lambda:InvokeFunction"
      Principal: "events.amazonaws.com"
      SourceArn: !GetAtt EventTndxRunnerUser.Arn

  PolicyTndxDDBAccess:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyName: !Sub "Tndx-${ParamInstanceName}-DDBAccess"
      Roles:
        - !Ref RoleLambdaExecution
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - dynamodb:GetItem
              - dynamodb:PutItem
              - dynamodb:Query
              - dynamodb:DeleteItem
            Resource:
              - !GetAtt DDBParametersTable.Arn
              - !GetAtt DDBRunnerTable.Arn
              - !GetAtt DDBFavoritesTable.Arn
              - !GetAtt DDBFollowersTable.Arn
              - !GetAtt DDBFriendsTable.Arn
              - !GetAtt DDBMediaTable.Arn

  PolicyTndxDeliveryAccess:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyName: !Sub "Tndx-${ParamInstanceName}-DeliveryAccess"
      Roles:
        - !Ref RoleLambdaExecution
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - firehose:PutRecord
              - firehose:PutRecordBatch
            Resource:
              - !GetAtt DeliveryStreamTweets.Arn

  GroupTndxROAccess:
    Type: AWS::IAM::Group
    Properties:
      GroupName: !Sub "Tndx-${ParamInstanceName}-ROAccess"

  PolicyTndxROAccess:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyName: !Sub "Tndx-${ParamInstanceName}-RO-Access"
      Groups:
        - !Ref GroupTndxROAccess
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - s3:GetObject
              - glue:GetTables
              - glue:GetDatabases
              - glue:GetTable
              - glue:BatchGetPartition
              - glue:GetPartitions
            Resource:
              - !Sub arn:aws:s3:::${S3Bucket}/processed/*
              - !Sub arn:aws:glue:${AWS::Region}:${AWS::AccountId}:catalog
              - !Sub arn:aws:glue:${AWS::Region}:${AWS::AccountId}:database/${GlueDatabaseTndx}
              - !Sub arn:aws:glue:${AWS::Region}:${AWS::AccountId}:table/${GlueDatabaseTndx}/*
          - Effect: Allow
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey
              - s3:ListBucket
            Resource:
              - !Sub arn:aws:kms:${AWS::Region}:${AWS::AccountId}:key/d401588e-f306-4b09-bdcb-f0fb4819f752
              - !Sub arn:aws:s3:::${S3Bucket}
          - Effect: Allow
            Action:
              - ssm:GetParameters
            Resource: !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/tndx/${ParamInstanceName}/*"
          - Effect: Allow
            Action:
              - sqs:GetQueueAttributes
            Resource:
              - !GetAtt SQSTndxRunner.Arn
          - Effect: Allow
            Action:
              - events:ListRules
            Resource: "*"
          - Effect: Allow
            Action:
              - glue:GetCrawler
            Resource:
              - !Sub arn:aws:glue:${AWS::Region}:${AWS::AccountId}:crawler/${GlueCrawlerTweets}

  PolicyTndxS3Access:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyName: !Sub "Tndx-${ParamInstanceName}-S3Access"
      Roles:
        - !Ref RoleLambdaExecution
        - !Ref RoleGlueCrawler
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - s3:ListBucket
            Resource: !Sub "arn:aws:s3:::${S3Bucket}"
          - Effect: Allow
            Action:
              - s3:PutObject
              - s3:GetObject
              - s3:GetObjectMetadata
            Resource: !Sub "arn:aws:s3:::${S3Bucket}/*"

  PolicyTndxSQSAccess:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyName: !Sub "Tndx-${ParamInstanceName}-SQSAccess"
      Roles:
        - !Ref RoleLambdaExecution
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - sqs:SendMessage
              - sqs:ReceiveMessage
              - sqs:DeleteMessage
              - sqs:GetQueueAttributes
            Resource:
              - !GetAtt SQSTndxRunner.Arn

  PolicyTndxSSMAccess:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyName: !Sub "Tndx-${ParamInstanceName}-ParameterStoreAccess"
      Roles:
        - !Ref RoleLambdaExecution
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - "ssm:GetParameter*"
            Resource: !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/tndx/${ParamInstanceName}/*"

  RoleDelivery:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: ""
            Effect: Allow
            Principal:
              Service: firehose.amazonaws.com
            Action: "sts:AssumeRole"
            Condition:
              StringEquals:
                "sts:ExternalId": !Ref "AWS::AccountId"
      Path: "/"
      Policies:
        - PolicyName: !Sub "tndx-${ParamInstanceName}-firehose_delivery"
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - "s3:AbortMultipartUpload"
                  - "s3:GetBucketLocation"
                  - "s3:GetObject"
                  - "s3:ListBucket"
                  - "s3:ListBucketMultipartUploads"
                  - "s3:PutObject"
                Resource:
                  - !Sub "arn:aws:s3:::${S3Bucket}"
                  - !Sub "arn:aws:s3:::${S3Bucket}/*"
              - Effect: Allow
                Action: "glue:GetTableVersions"
                Resource: "*"
              - Effect: Allow
                Action:
                  - "logs:*"
                Resource: "*"

  RoleGlueCrawler:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - glue.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSGlueServiceRole
      Tags:
        - Key: "Environment"
          Value: { Ref: ParamEnvironment }
        - Key: "Application"
          Value: { Ref: ParamAppName }
        - Key: "Instance"
          Value: { Ref: ParamInstanceName }

  RoleLambdaExecution:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - "lambda.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
        - "arn:aws:iam::aws:policy/AmazonRekognitionReadOnlyAccess"
      Tags:
        - Key: "Environment"
          Value: { Ref: ParamEnvironment }
        - Key: "Application"
          Value: { Ref: ParamAppName }
        - Key: "Instance"
          Value: { Ref: ParamInstanceName }

  S3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      BucketName: { Ref: S3BucketName }
      VersioningConfiguration:
        Status: Suspended
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: "Environment"
          Value: { Ref: ParamEnvironment }
        - Key: "Application"
          Value: { Ref: ParamAppName }
        - Key: "Instance"
          Value: { Ref: ParamInstanceName }

  SQSTndxRunner:
    Type: AWS::SQS::Queue
    Properties:
      KmsMasterKeyId: alias/aws/sqs
      VisibilityTimeout: 60
      Tags:
        - Key: "Environment"
          Value: { Ref: ParamEnvironment }
        - Key: "Application"
          Value: { Ref: ParamAppName }
        - Key: "Instance"
          Value: { Ref: ParamInstanceName }

Outputs:
  InstanceName:
    Description: The name of the instance
    Value: !Ref ParamInstanceName
  RunnerName:
    Description: Runner Name (use for runner/database setup)
    Value: !Ref ParamRunnerName
  TwitterAPIKey:
    Description: Twitter API key must be set in SSM Parameter Store
    Value: !Ref ParameterTwitterAPIKey
  TwitterAPISecret:
    Description: Twitter API secret must be set in SSM Parameter Store
    Value: !Ref ParameterTwitterAPISecret
  EventTndxRunnerFavoritesName:
    Description: Tndx Runner Favorites event (currently disabled)
    Value: !Ref EventTndxRunnerFavorites
  EventTndxRunnerFollowersName:
    Description: Event Tndx Runner Followers event (currently disabled)
    Value: !Ref EventTndxRunnerFollowers
  EventTndxRunnerFriendsName:
    Description: Event Tndx Runner Friends event (currently disabled)
    Value: !Ref EventTndxRunnerFriends
  EventTndxRunnerTimelineName:
    Description: Event Tndx Runner Timeline event (currently disabled)
    Value: !Ref EventTndxRunnerTimeline
  EventTndxRunnerUserName:
    Description: Event Tndx Runner User event (currently disabled)
    Value: !Ref EventTndxRunnerUser
